<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAST Data Usage Tracker</title>
    <style>
        /* General Body Styles */
        body {
            background-color: #FFFFFF;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            height: 100vh;
            margin: 0;
            color: #424242;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hide original elements */
        .meter, .real-time-meter, footer, .central-logo, .meter-logo {
            display: none;
        }

        /* Central Controls */
        .controls-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #status-text {
            font-size: 36px;
            font-weight: 300;
            color: #424242;
            margin-bottom: 30px;
        }

        .button-wrapper {
            display: flex;
            align-items: center;
            gap: 20px; /* Space between buttons */
        }

        #pause-button {
            padding: 10px 25px;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid #E50914;
            background-color: #E50914;
            color: white;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
            width: 120px; /* Fixed width for consistency */
        }

        #pause-button:hover {
            background-color: #c00711;
            border-color: #c00711;
        }

        #refresh-button {
            width: 40px;
            height: 40px;
            border: 2px solid #9E9E9E;
            border-radius: 50%;
            background-color: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #008000;
            font-size: 24px;
            font-weight: bold;
            transition: transform 0.8s ease-in-out;
        }

        #refresh-button.testing {
            transform: rotate(360deg);
        }
    </style>
</head>
<body>

    <!-- Hidden Data Meters -->
    <div class="meter" id="meter-megabit"><div class="data-usage-container"><span class="data-usage-value" id="megabit-value">0.00</span></div></div>
    <div class="meter" id="meter-megabyte"><div class="data-usage-container"><span class="data-usage-value" id="megabyte-value">0.00</span></div></div>
    <div class="meter" id="meter-gigabit"><div class="data-usage-container"><span class="data-usage-value" id="gigabit-value">0.00</span></div></div>
    <div class="meter" id="meter-gigabyte"><div class="data-usage-container"><span class="data-usage-value" id="gigabyte-value-disp">0.00</span></div></div>
    <div class="meter" id="meter-terabit"><div class="data-usage-container"><span class="data-usage-value" id="terabit-value">0.00</span></div></div>
    <div class="meter" id="meter-terabyte"><div class="data-usage-container"><span class="data-usage-value" id="terabyte-value">0.00</span></div></div>
    <div class="real-time-meter" id="meter-realtime-mbps"><div class="data-usage-container"><span class="data-usage-value" id="realtime-mbps">0.00</span></div></div>
    <div class="real-time-meter" id="meter-realtime-mbs"><div class="data-usage-container"><span class="data-usage-value" id="realtime-mbs">0.00</span></div></div>
    <footer></footer>

    <!-- Central Controls -->
    <div class="controls-container">
        <h1 id="status-text">Test Running...</h1>
        <div class="button-wrapper">
            <button id="pause-button">Pause</button>
            <button id="refresh-button">&#8635;</button>
        </div>
    </div>

    <script>
        // Element references (even for hidden ones to keep logic working)
        const megabitElement = document.getElementById('megabit-value');
        const megabyteElement = document.getElementById('megabyte-value');
        const gigabitElement = document.getElementById('gigabit-value');
        const gigabyteElement = document.getElementById('gigabyte-value-disp');
        const terabitElement = document.getElementById('terabit-value');
        const terabyteElement = document.getElementById('terabyte-value');
        const realtimeMbpsElement = document.getElementById('realtime-mbps');
        const realtimeMbsElement = document.getElementById('realtime-mbs');
        
        // Control elements
        const refreshButton = document.getElementById('refresh-button');
        const pauseButton = document.getElementById('pause-button');
        const statusText = document.getElementById('status-text');
        
        // Test configuration
        const DOWNLOAD_TEST_FILE = 'https://cachefly.cachefly.net/10mb.test';
        const CONCURRENT_DOWNLOADS = 10;
        const STORAGE_KEY = 'totalDataUsed';
        
        // State variables
        let continueTesting = false;
        let isPaused = false;
        let activeXHRs = [];
        let totalDownloadedBytes = parseFloat(localStorage.getItem(STORAGE_KEY)) || 0;
        
        let lastProgressTime = Date.now();
        let bytesSinceLastProgress = 0;

        function updateDataUsageDisplay() {
            const megabytes = totalDownloadedBytes / (1024 * 1024);
            // The rest of the calculations are kept for data integrity but are not displayed
            megabitElement.textContent = ((totalDownloadedBytes * 8) / (1024 * 1024)).toFixed(2);
            megabyteElement.textContent = megabytes.toFixed(2);
            gigabitElement.textContent = ((totalDownloadedBytes * 8) / (1024 * 1024 * 1024)).toFixed(2);
            gigabyteElement.textContent = (totalDownloadedBytes / (1024 * 1024 * 1024)).toFixed(2);
            terabitElement.textContent = ((totalDownloadedBytes * 8) / (1024 * 1024 * 1024 * 1024)).toFixed(2);
            terabyteElement.textContent = (totalDownloadedBytes / (1024 * 1024 * 1024 * 1024)).toFixed(2);
        }

        function updateRealTimeSpeed(bytes, durationMs) {
            // This function is not visually represented but can be used for debugging
            if (durationMs === 0) return;
            // ... calculations ...
        }

        function runSingleDownload() {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                activeXHRs.push(xhr);
                
                let lastLoaded = 0;

                xhr.open('GET', `${DOWNLOAD_TEST_FILE}?r=${Date.now()}&i=${Math.random()}`, true);
                
                xhr.onprogress = (event) => {
                    if (event.lengthComputable) {
                         const bytesDiff = event.loaded - lastLoaded;
                         totalDownloadedBytes += bytesDiff;
                         bytesSinceLastProgress += bytesDiff;
                         lastLoaded = event.loaded;
                         
                         const now = Date.now();
                         const timeDiff = now - lastProgressTime;
                         
                         if(timeDiff >= 200){
                             updateRealTimeSpeed(bytesSinceLastProgress, timeDiff);
                             bytesSinceLastProgress = 0;
                             lastProgressTime = now;
                         }
                         updateDataUsageDisplay();
                    }
                };

                xhr.onload = () => (xhr.status === 200 ? resolve() : reject());
                xhr.onerror = () => reject();
                xhr.onabort = () => resolve();
                xhr.ontimeout = () => reject();
                xhr.send();
            }).finally(() => {
                activeXHRs = activeXHRs.filter(x => x !== xhr);
            });
        }
        
        async function startContinuousTesting() {
            if (continueTesting) return; 

            continueTesting = true;
            isPaused = false;
            statusText.textContent = 'Test Running...';
            pauseButton.textContent = 'Pause';
            refreshButton.classList.add('testing');

            while (continueTesting) {
                const downloadPromises = Array.from({ length: CONCURRENT_DOWNLOADS }, () => runSingleDownload());
                try {
                    await Promise.all(downloadPromises);
                } catch (error) {
                    console.error("One or more downloads failed. Continuing...");
                }
                if (!continueTesting) break;
            }
            
            refreshButton.classList.remove('testing');
        }

        // Pause/Resume Button Functionality
        pauseButton.addEventListener('click', () => {
            isPaused = !isPaused;
            if (isPaused) {
                // Pause the test
                continueTesting = false;
                activeXHRs.forEach(xhr => xhr.abort());
                activeXHRs = [];
                statusText.textContent = 'Test Paused';
                pauseButton.textContent = 'Resume';
            } else {
                // Resume the test
                startContinuousTesting();
            }
        });

        // Refresh (Reset) Button Functionality
        refreshButton.addEventListener('click', () => {
            // Stop any ongoing test
            continueTesting = false; 
            activeXHRs.forEach(xhr => xhr.abort());
            activeXHRs = [];
            
            // Reset counters and storage
            totalDownloadedBytes = 0;
            localStorage.removeItem(STORAGE_KEY);
            updateDataUsageDisplay();
            
            // Ensure UI is in a running state
            if (isPaused) {
                isPaused = false;
            }
            
            // Start a new test after a short delay
            setTimeout(startContinuousTesting, 100);
        });

        window.addEventListener('beforeunload', () => {
            localStorage.setItem(STORAGE_KEY, totalDownloadedBytes);
        });

        window.onload = () => {
            updateDataUsageDisplay();
            startContinuousTesting();
        };

    </script>
</body>
</html>
